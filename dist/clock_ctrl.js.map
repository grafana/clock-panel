{"version":3,"sources":["../src/clock_ctrl.js"],"names":["PanelCtrl","moment","_","panelDefaults","mode","clockType","offsetFromUtc","offsetFromUtcMinutes","timezone","bgColor","countdownSettings","endCountdownTime","seconds","milliseconds","add","toDate","endText","dateSettings","showDate","dateFormat","fontSize","fontWeight","timeSettings","showClock","customFormat","zoneSettings","showZone","zoneFormat","ClockCtrl","$scope","$injector","defaults","panel","timezones","tz","names","guess","Date","events","on","onInitEditMode","bind","onPanelTeardown","render","updateClock","addEditorTab","$timeout","cancel","nextTickPromise","renderTime","renderCountdown","now","offsetInMinutes","parseInt","utcOffset","date","format","time","getTimeFormat","zone","_z","name","timeLeft","duration","diff","formattedTimeLeft","asSeconds","previous","years","months","days","hours","minutes","scope","elem","$panelContainer","find","css","templateUrl"],"mappings":"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","file":"clock_ctrl.js","sourcesContent":["import {PanelCtrl} from 'app/plugins/sdk';\nimport moment from 'moment';\nimport 'moment-timezone';\nimport _ from 'lodash';\nimport './css/clock-panel.css!';\n\nconst panelDefaults = {\n  mode: 'time',\n// begin deprecated\n  clockType: '24 hour',\n  offsetFromUtc: null,\n  offsetFromUtcMinutes: null,\n  timezone: null,\n// end deprecated\n//  timezone: moment.tz.guess(),\n  bgColor: null,\n  countdownSettings: {\n    endCountdownTime: moment().seconds(0).milliseconds(0).add(1, 'day').toDate(),\n    endText: '00:00:00'\n  },\n  dateSettings: {\n    showDate: false,\n    dateFormat: 'YYYY-MM-DD',\n    fontSize: '20px',\n    fontWeight: 'normal'\n  },\n  timeSettings: {\n    showClock: true,\n    clockType: null,\n//    clockType: '24 hour',\n    customFormat: 'HH:mm:ss',\n    fontSize: '60px',\n    fontWeight: 'normal'\n  },\n  zoneSettings: {\n    showZone: false,\n    zoneFormat: 'offsetAbv',\n    fontSize: '20px',\n    fontWeight: 'normal'\n  }\n};\n\nexport class ClockCtrl extends PanelCtrl {\n  constructor($scope, $injector) {\n    super($scope, $injector);\n    _.defaults(this.panel, panelDefaults);\n    _.defaults(this.panel.timeSettings, panelDefaults.timeSettings);\n    this.timezones = moment.tz.names();\n\n    // handle upgrade period\n    // once upgrade period is completed, these can be set as the defaults above\n    if (!this.panel.timeSettings.clockType) {\n      this.panel.timeSettings.clockType = this.panel.clockType;\n    }\n\n    if (!this.panel.timezone) {\n      if ((!this.panel.offsetFromUtc) && (!this.panel.offsetFromUtcMinutes)) {\n        this.panel.timezone = moment.tz.guess();\n      }\n    }\n    // end upgrade period\n\n    if (!(this.panel.countdownSettings.endCountdownTime instanceof Date)) {\n      this.panel.countdownSettings.endCountdownTime = moment(this.panel.countdownSettings.endCountdownTime).toDate();\n    }\n\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n    this.events.on('panel-teardown', this.onPanelTeardown.bind(this));\n    this.events.on('panel-initialized', this.render.bind(this));\n\n    this.updateClock();\n  }\n\n  onInitEditMode() {\n    this.addEditorTab('Options', 'public/plugins/grafana-clock-panel/editor.html', 2);\n  }\n\n  onPanelTeardown() {\n    this.$timeout.cancel(this.nextTickPromise);\n  }\n\n  updateClock() {\n    if (this.panel.mode === 'time') {\n      this.renderTime();\n    } else {\n      this.renderCountdown();\n    }\n\n    this.nextTickPromise = this.$timeout(this.updateClock.bind(this), 1000);\n  }\n\n  renderTime() {\n    let now;\n\n    // handle upgrade period\n    // if timezone is defined that means we are on the current model\n    // otherwise fall back to using offsetFromUtc, if those are also not present, guess at the timezone\n    // once upgrade period is over, this block becomes \"now = moment().tz(this.panel.timezone);\"\n    if (this.panel.timezone) {\n      now = moment().tz(this.panel.timezone);\n    } else if (this.panel.offsetFromUtc && this.panel.offsetFromUtcMinutes) {\n      const offsetInMinutes = (parseInt(this.panel.offsetFromUtc, 10) * 60) + parseInt(this.panel.offsetFromUtcMinutes, 10);\n      now = moment().utcOffset(offsetInMinutes);\n    } else if (this.panel.offsetFromUtc && !this.panel.offsetFromUtcMinutes) {\n      now = moment().utcOffset(parseInt(this.panel.offsetFromUtc, 10));\n    } else {\n      now = moment().tz(moment.tz.guess());\n    }\n    // end upgrade period\n\n    this.date = now.format(this.panel.dateSettings.dateFormat);\n\n    this.time = now.format(this.getTimeFormat());\n\n    if (this.panel.zoneSettings.zoneFormat === 'name' && this.panel.timezone) {\n      this.zone = now._z.name\n    } else if (this.panel.zoneSettings.zoneFormat === 'offsetAbv') {\n      this.zone = now.format('Z z');\n    } else if (this.panel.zoneSettings.zoneFormat === 'offset') {\n      this.zone = now.format('Z');\n    } else if (this.panel.zoneSettings.zoneFormat === 'abv') {\n      this.zone = now.format('z');\n    }\n  }\n\n  getTimeFormat() {\n    if (this.panel.timeSettings.clockType === '24 hour') {\n      return 'HH:mm:ss';\n    }\n\n    if (this.panel.timeSettings.clockType === '12 hour') {\n      return 'h:mm:ss A';\n    }\n\n    return this.panel.timeSettings.customFormat;\n  }\n\n  renderCountdown() {\n    if (!this.panel.countdownSettings.endCountdownTime) {\n      this.time = this.panel.countdownSettings.endText;\n    }\n\n    const now = moment();\n    const timeLeft = moment.duration(moment(this.panel.countdownSettings.endCountdownTime).diff(now));\n    let formattedTimeLeft = '';\n\n    if (timeLeft.asSeconds() <= 0) {\n      this.time = this.panel.countdownSettings.endText;\n      return;\n    }\n\n    var previous = '';\n\n    if (timeLeft.years() > 0) {\n      formattedTimeLeft = timeLeft.years() === 1 ? '1 year, ' : timeLeft.years() + ' years, ';\n      previous = 'years';\n    }\n    if (timeLeft.months() > 0 || previous === 'years') {\n      formattedTimeLeft += timeLeft.months() === 1 ? '1 month, ' : timeLeft.months() + ' months, ';\n      previous = 'month';\n    }\n    if (timeLeft.days() > 0 || previous === 'months') {\n      formattedTimeLeft += timeLeft.days() === 1 ? '1 day, ' : timeLeft.days() + ' days, ';\n      previous = 'days';\n    }\n    if (timeLeft.hours() > 0 || previous === 'days') {\n      formattedTimeLeft += timeLeft.hours() === 1 ? '1 hour, ' : timeLeft.hours() + ' hours, ';\n      previous = 'hours';\n    }\n\n    if (timeLeft.minutes() > 0 || previous === 'hours') {\n      formattedTimeLeft += timeLeft.minutes() === 1 ? '1 minute, ' : timeLeft.minutes() + ' minutes, ';\n    }\n\n    formattedTimeLeft += timeLeft.seconds() === 1 ? '1 second ' : timeLeft.seconds() + ' seconds';\n    this.time = formattedTimeLeft;\n  }\n\n  link(scope, elem) {\n    this.events.on('render', () => {\n      const $panelContainer = elem.find('.panel-container');\n\n      if (this.panel.bgColor) {\n        $panelContainer.css('background-color', this.panel.bgColor);\n      } else {\n        $panelContainer.css('background-color', '');\n      }\n    });\n  }\n}\n\nClockCtrl.templateUrl = 'module.html';\n"]}